# 预设音频使用指南

## 概述

LiveTalking 项目已经内置了预设音频功能，可以使用预先生成的音频文件来驱动数字人，避免实时TTS生成的延迟。这对于固定话术、欢迎语、常见问答等场景非常有用。

## 工作原理

系统通过 `custom_config.json` 配置文件加载预设的音频和对应的图像序列，每个预设音频都有一个唯一的 `audiotype` 标识符。当需要播放时，通过API调用切换到对应的 `audiotype` 即可。

## 配置步骤

### 1. 准备音频和图像文件

首先，您需要准备：
- **音频文件**：16kHz采样率的 WAV 格式音频文件
- **图像序列**：与音频同步的数字人图像帧序列

**推荐工作流程：**

1. 准备要说的文本内容
2. 使用TTS服务（EdgeTTS、GPT-SoVITS等）提前生成音频文件
3. 使用 LiveTalking 的录制功能或离线处理生成对应的图像序列

**目录结构示例：**
```
data/
  custom_audio/
    welcome/
      audio.wav          # 欢迎语音频
      image/             # 对应的图像帧
        0000.jpg
        0001.jpg
        0002.jpg
        ...
    greeting/
      audio.wav          # 问候语音频
      image/
        0000.jpg
        0001.jpg
        ...
    faq_1/
      audio.wav          # 常见问题1的回答音频
      image/
        0000.jpg
        ...
```

### 2. 配置 custom_config.json

编辑 `data/custom_config.json` 文件，添加预设音频配置：

```json
[
   {
        "audiotype": 1,
        "imgpath": "data/custom_audio/idle/image",
        "audiopath": "data/custom_audio/idle/audio.wav"
   },
   {
        "audiotype": 2,
        "imgpath": "data/custom_audio/welcome/image",
        "audiopath": "data/custom_audio/welcome/audio.wav"
   },
   {
        "audiotype": 3,
        "imgpath": "data/custom_audio/greeting/image",
        "audiopath": "data/custom_audio/greeting/audio.wav"
   },
   {
        "audiotype": 4,
        "imgpath": "data/custom_audio/faq_1/image",
        "audiopath": "data/custom_audio/faq_1/audio.wav"
   }
]
```

**配置说明：**
- `audiotype`：唯一标识符（整数），用于API调用时指定播放哪个预设音频
- `imgpath`：图像序列文件夹路径
- `audiopath`：音频文件路径

**建议的 audiotype 编号规划：**
- `1`: 静默/待机状态
- `2`: 欢迎语
- `3-10`: 常用问候语
- `11-50`: 常见问题回答
- `51-100`: 特殊场景预设

### 3. 重启服务

修改配置文件后，需要重启 LiveTalking 服务以加载新的配置。

## API 使用

### 播放预设音频

通过 POST 请求调用 `/set_audiotype` 接口：

**请求示例：**
```javascript
// 播放欢迎语（audiotype=2）
fetch('http://localhost:8010/set_audiotype', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        sessionid: 0,        // 会话ID
        audiotype: 2,        // 要播放的预设音频类型
        reinit: true         // 是否从头开始播放（true=从头播放，false=继续播放）
    })
});
```

**Python 示例：**
```python
import requests

def play_preset_audio(audiotype, reinit=True, sessionid=0):
    url = "http://localhost:8010/set_audiotype"
    data = {
        "sessionid": sessionid,
        "audiotype": audiotype,
        "reinit": reinit
    }
    response = requests.post(url, json=data)
    return response.json()

# 播放欢迎语
play_preset_audio(audiotype=2)

# 播放常见问题回答
play_preset_audio(audiotype=4)
```

**cURL 示例：**
```bash
curl -X POST http://localhost:8010/set_audiotype \
  -H "Content-Type: application/json" \
  -d '{"sessionid":0,"audiotype":2,"reinit":true}'
```

## 实际应用场景

### 场景1：智能客服欢迎语

```javascript
// 用户进入时播放欢迎语
async function onUserEnter() {
    await fetch('/set_audiotype', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            sessionid: 0,
            audiotype: 2,  // 欢迎语
            reinit: true
        })
    });
}
```

### 场景2：常见问题快捷回复

```javascript
const FAQ_RESPONSES = {
    'opening_hours': 11,  // "我们的营业时间是..."
    'location': 12,       // "我们的地址在..."
    'price': 13,          // "价格信息如下..."
    'contact': 14         // "您可以通过以下方式联系我们..."
};

function playFAQ(questionType) {
    fetch('/set_audiotype', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            sessionid: 0,
            audiotype: FAQ_RESPONSES[questionType],
            reinit: true
        })
    });
}

// 用户点击"营业时间"按钮
playFAQ('opening_hours');
```

### 场景3：结合智能识别的混合模式

```javascript
async function handleUserQuery(userText) {
    // 检查是否是预设的常见问题
    const presetResponse = checkPresetQuestions(userText);
    
    if (presetResponse) {
        // 使用预设音频，零延迟响应
        await fetch('/set_audiotype', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                sessionid: 0,
                audiotype: presetResponse.audiotype,
                reinit: true
            })
        });
    } else {
        // 使用实时TTS生成
        await fetch('/human', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                sessionid: 0,
                type: 'chat',
                text: userText,
                interrupt: false
            })
        });
    }
}

function checkPresetQuestions(text) {
    const presets = [
        {keywords: ['营业时间', '几点', '开门'], audiotype: 11},
        {keywords: ['地址', '在哪', '位置'], audiotype: 12},
        {keywords: ['价格', '多少钱', '费用'], audiotype: 13},
        {keywords: ['联系', '电话', '微信'], audiotype: 14},
    ];
    
    for (let preset of presets) {
        if (preset.keywords.some(kw => text.includes(kw))) {
            return preset;
        }
    }
    return null;
}
```

## 生成预设音频的方法

### 方法1：使用EdgeTTS预生成

```python
import asyncio
import edge_tts

async def generate_preset_audio(text, output_path, voice="zh-CN-YunxiaNeural"):
    """使用EdgeTTS生成预设音频"""
    communicate = edge_tts.Communicate(text, voice)
    await communicate.save(output_path)

# 生成欢迎语音频
asyncio.run(generate_preset_audio(
    "您好！欢迎使用我们的服务，我是您的智能助手，有什么可以帮您的吗？",
    "data/custom_audio/welcome/audio.wav"
))
```

### 方法2：使用GPT-SoVITS克隆音色

如果您使用 GPT-SoVITS，可以提前批量生成音频：

```python
import requests

def generate_sovits_audio(text, ref_audio, ref_text, output_path):
    """使用GPT-SoVITS生成音频"""
    url = "http://localhost:9880"
    params = {
        "text": text,
        "text_language": "zh",
        "ref_audio_path": ref_audio,
        "prompt_text": ref_text,
        "prompt_language": "zh",
        "media_type": "wav"
    }
    
    response = requests.get(url, params=params)
    with open(output_path, 'wb') as f:
        f.write(response.content)

# 批量生成常见问题回答
faqs = [
    ("我们的营业时间是每天上午9点到晚上6点", "faq_1"),
    ("我们的地址在XX市XX区XX街道123号", "faq_2"),
    ("具体价格请查看我们的价目表，基础套餐从299元起", "faq_3"),
]

for text, name in faqs:
    generate_sovits_audio(
        text,
        "reference.wav",
        "参考文本",
        f"data/custom_audio/{name}/audio.wav"
    )
```

### 方法3：使用LiveTalking录制功能

1. 启动 LiveTalking 服务
2. 发送要生成的文本通过 `/human` 接口
3. 使用录制功能捕获生成的视频和音频
4. 提取音频和图像帧保存到对应目录

## 性能优化建议

### 1. 音频格式优化
- 采样率：16kHz（与系统一致）
- 格式：WAV（PCM）
- 声道：单声道
- 位深度：16-bit

### 2. 图像序列优化
- 格式：JPEG（平衡质量和大小）
- 分辨率：与您的数字人模型一致
- 帧率：25fps（与视频输出一致）
- 命名：使用零填充的数字序列（0000.jpg, 0001.jpg...）

### 3. 内存管理
- 不要配置过多的预设音频（建议不超过20个）
- 较长的音频会占用更多内存
- 可以考虑按需加载机制（需要修改代码）

### 4. 混合策略
- 高频问题：使用预设音频
- 低频问题：使用实时TTS
- 个性化回复：使用实时TTS
- 固定话术：使用预设音频

## 注意事项

1. **播放完成后的状态**：当预设音频播放完成后，系统会自动切换到 `audiotype=1` 的静默状态
2. **中断机制**：如果需要中断当前播放，调用 `/interrupt_talk` 接口
3. **音频同步**：确保图像序列的帧数与音频时长匹配（帧数 = 音频秒数 × 25）
4. **路径格式**：使用相对路径或绝对路径都可以，建议使用相对于项目根目录的相对路径

## 故障排查

### 问题：调用后没有播放
- 检查 `custom_config.json` 格式是否正确
- 确认 `audiotype` 存在于配置中
- 查看服务日志确认配置是否加载成功
- 验证音频和图像文件路径是否正确

### 问题：播放卡顿或不同步
- 检查图像序列的帧数是否正确
- 确认音频采样率为16kHz
- 检查图像文件命名是否连续

### 问题：音频质量差
- 使用更高质量的TTS服务预生成
- 确保音频格式为16-bit PCM WAV
- 避免重复压缩转换

## 进阶：扩展预设音频功能

### 添加文本到预设音频的映射

您可以创建一个配置文件来维护文本和预设音频的映射：

```json
// preset_mapping.json
{
    "欢迎": 2,
    "你好": 2,
    "您好": 2,
    "营业时间": 11,
    "几点开门": 11,
    "地址在哪": 12,
    "怎么去": 12
}
```

然后在应用中使用：

```javascript
async function smartResponse(userText) {
    const mapping = await fetch('/preset_mapping.json').then(r => r.json());
    
    for (let [keyword, audiotype] of Object.entries(mapping)) {
        if (userText.includes(keyword)) {
            await fetch('/set_audiotype', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({sessionid: 0, audiotype, reinit: true})
            });
            return;
        }
    }
    
    // 没有匹配的预设，使用实时TTS
    await fetch('/human', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sessionid: 0, type: 'chat', text: userText})
    });
}
```

## 总结

使用预设音频功能的优势：
- ✅ **零延迟**：无需等待TTS生成
- ✅ **高质量**：可以使用最好的TTS服务预生成
- ✅ **稳定性**：避免在线TTS服务的网络问题
- ✅ **成本优化**：减少实时TTS API调用次数

适用场景：
- 欢迎语、问候语
- 常见问题回答（FAQ）
- 固定话术（如产品介绍、服务说明）
- 紧急通知、重要提示
- 多语言场景（预先生成多语言版本）

通过合理使用预设音频功能，可以显著提升数字人的响应速度和用户体验！
