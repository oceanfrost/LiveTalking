<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC webcam</title>
    <style>
    button {
        padding: 8px 16px;
    }

    video {
        width: 100%;
        display: none; /* 隐藏原始video，使用canvas显示 */
    }

    #output-canvas {
        width: 600px;
        background: transparent;
        /* 可以设置任意背景，比如图片或颜色 */
        /* background-image: url('your-background.jpg'); */
        /* background-color: #00ff00; */ /* 绿色背景测试 */
    }

    .option {
        margin-bottom: 8px;
    }

    #media {
        max-width: 1280px;
    }

    .background-options {
        margin: 10px 0;
    }
    .background-options label {
        margin-right: 15px;
    }
    </style>
</head>
<body>

<div class="option">
    <input id="use-stun" type="checkbox"/>
    <label for="use-stun">Use STUN server</label>
</div>
<button id="start" onclick="start()">Start</button>
<button id="stop" style="display: none" onclick="stop()">Stop</button>
<button class="btn btn-primary" id="btn_start_record">Start Recording</button>
<button class="btn btn-primary" id="btn_stop_record" disabled>Stop Recording</button>
<!-- <button class="btn btn-primary" id="btn_download">Download Video</button> -->
<input type="hidden" id="sessionid" value="0">
<form class="form-inline" id="echo-form">
    <div class="form-group">
      <p>input text</p>

      <textarea cols="2" rows="3" style="width:600px;height:50px;" class="form-control" id="message">test</textarea>
    </div>
    <button type="submit" class="btn btn-default">Send</button>
  </form>

<div id="media">
    <h2>Media</h2>
    
    <div class="background-options">
        <label><input type="radio" name="bg" value="transparent" checked> 透明背景</label>
        <label><input type="radio" name="bg" value="white"> 白色背景</label>
        <label><input type="radio" name="bg" value="blue"> 蓝色背景</label>
        <label><input type="radio" name="bg" value="image"> 图片背景</label>
        <br>
        <label>绿幕容差: <input type="range" id="tolerance" min="0" max="150" value="80"> <span id="tolerance-val">80</span></label>
        <label>边缘柔化: <input type="range" id="softness" min="0" max="50" value="20"> <span id="softness-val">20</span></label>
        <label><input type="checkbox" id="spill-suppression" checked> 去除绿色溢出</label>
    </div>

    <audio id="audio" autoplay="true"></audio>
    <video id="video" style="width:600px;" autoplay="true" playsinline="true"></video>
    <canvas id="output-canvas"></canvas>
</div>

<script>
// 绿幕色度键处理
let videoElement = null;
let canvasElement = null;
let ctx = null;
let animationId = null;

// 色度键参数
let tolerance = 80;      // 绿色容差
let softness = 20;       // 边缘柔化范围
let spillSuppression = true;  // 绿色溢出抑制

function initChromaKey() {
    videoElement = document.getElementById('video');
    canvasElement = document.getElementById('output-canvas');
    ctx = canvasElement.getContext('2d', { willReadFrequently: true });
    
    // 监听视频元数据加载
    videoElement.addEventListener('loadedmetadata', () => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        startProcessing();
    });
    
    // 如果视频已经在播放
    videoElement.addEventListener('play', () => {
        if (canvasElement.width === 0) {
            canvasElement.width = videoElement.videoWidth || 600;
            canvasElement.height = videoElement.videoHeight || 400;
        }
        startProcessing();
    });
    
    // 容差滑块
    document.getElementById('tolerance').addEventListener('input', (e) => {
        tolerance = parseInt(e.target.value);
        document.getElementById('tolerance-val').textContent = tolerance;
    });
    
    // 柔化滑块
    document.getElementById('softness').addEventListener('input', (e) => {
        softness = parseInt(e.target.value);
        document.getElementById('softness-val').textContent = softness;
    });
    
    // 溢出抑制
    document.getElementById('spill-suppression').addEventListener('change', (e) => {
        spillSuppression = e.target.checked;
    });
    
    // 背景选项
    document.querySelectorAll('input[name="bg"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const canvas = document.getElementById('output-canvas');
            switch(e.target.value) {
                case 'transparent':
                    canvas.style.background = 'linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)';
                    canvas.style.backgroundSize = '20px 20px';
                    canvas.style.backgroundPosition = '0 0, 0 10px, 10px -10px, -10px 0px';
                    canvas.style.backgroundColor = '#fff';
                    break;
                case 'white':
                    canvas.style.background = '#ffffff';
                    canvas.style.backgroundSize = '';
                    canvas.style.backgroundPosition = '';
                    break;
                case 'blue':
                    canvas.style.background = '#0066ff';
                    canvas.style.backgroundSize = '';
                    canvas.style.backgroundPosition = '';
                    break;
                case 'image':
                    canvas.style.background = 'url("https://picsum.photos/800/600") center/cover';
                    canvas.style.backgroundSize = 'cover';
                    canvas.style.backgroundPosition = 'center';
                    break;
            }
        });
    });
    
    // 默认显示棋盘格背景（表示透明）
    document.querySelector('input[name="bg"][value="transparent"]').dispatchEvent(new Event('change'));
}

function startProcessing() {
    if (animationId) return;
    processFrame();
}

function processFrame() {
    if (videoElement.paused || videoElement.ended) {
        animationId = null;
        return;
    }
    
    // 绘制视频帧到canvas
    ctx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
    
    // 获取像素数据
    const imageData = ctx.getImageData(0, 0, canvasElement.width, canvasElement.height);
    const data = imageData.data;
    
    // 色度键处理 - 去除绿色背景
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // 计算绿色主导程度
        // 纯绿色: g高，r和b低
        const greenDominance = g - Math.max(r, b);
        
        if (greenDominance > 0) {
            // 计算与纯绿色的距离
            const greenness = greenDominance / 255;
            const threshold = tolerance / 255;
            const soft = softness / 255;
            
            if (greenness > threshold) {
                // 完全透明
                data[i + 3] = 0;
            } else if (greenness > threshold - soft && soft > 0) {
                // 边缘柔化（半透明过渡）
                const alpha = (threshold - greenness) / soft;
                data[i + 3] = Math.round(alpha * 255);
                
                // 绿色溢出抑制
                if (spillSuppression && data[i + 3] > 0) {
                    data[i + 1] = Math.min(g, Math.max(r, b));
                }
            } else if (spillSuppression) {
                // 非透明区域的绿色溢出抑制
                const spillAmount = g - Math.max(r, b);
                if (spillAmount > 20) {
                    data[i + 1] = Math.max(r, b) + 20;
                }
            }
        }
    }
    
    // 放回处理后的像素数据
    ctx.putImageData(imageData, 0, 0);
    
    animationId = requestAnimationFrame(processFrame);
}

function stopProcessing() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', initChromaKey);
</script>

<script src="client.js"></script>
<script src="https://unpkg.com/kd-shim-sockjs-client@0.3.4/sockjs-0.3.4.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</body>
<script type="text/javascript" charset="utf-8">

	$(document).ready(function() {
	  // var host = window.location.hostname
	  // var ws = new WebSocket("ws://"+host+":8000/humanecho");
	  // //document.getElementsByTagName("video")[0].setAttribute("src", aa["video"]);
	  // ws.onopen = function() {
		// console.log('Connected');
	  // };
	  // ws.onmessage = function(e) {
		// console.log('Received: ' + e.data);
		// data = e
		// var vid = JSON.parse(data.data); 
		// console.log(typeof(vid),vid)
		// //document.getElementsByTagName("video")[0].setAttribute("src", vid["video"]);
		
	  // };
	  // ws.onclose = function(e) {
		// console.log('Closed');
	  // };

	  $('#echo-form').on('submit', function(e) {
      e.preventDefault();
      var message = $('#message').val();
      console.log('Sending: ' + message);
      console.log('sessionid: ',document.getElementById('sessionid').value);
      fetch('/human', {
            body: JSON.stringify({
                text: message,
                type: 'echo',
                interrupt: true,
                sessionid:parseInt(document.getElementById('sessionid').value),
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            method: 'POST'
      });
      //ws.send(message);
      $('#message').val('');
	  });

    $('#btn_start_record').click(function() {
        // 开始录制
        console.log('Starting recording...');
        fetch('/record', {
            body: JSON.stringify({
                    type: 'start_record',
                    sessionid:parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
            method: 'POST'
        }).then(function(response) {
            if (response.ok) {
                console.log('Recording started.');
                $('#btn_start_record').prop('disabled', true);
                $('#btn_stop_record').prop('disabled', false);
                // $('#btn_download').prop('disabled', true);
            } else {
                console.error('Failed to start recording.');
            }
        }).catch(function(error) {
            console.error('Error:', error);
        });
    });

    $('#btn_stop_record').click(function() {
        // 结束录制
        console.log('Stopping recording...');
        fetch('/record', {
            body: JSON.stringify({
                    type: 'end_record',
                    sessionid:parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
            method: 'POST'
        }).then(function(response) {
            if (response.ok) {
                console.log('Recording stopped.');
                $('#btn_start_record').prop('disabled', false);
                $('#btn_stop_record').prop('disabled', true);
                // $('#btn_download').prop('disabled', false);
            } else {
                console.error('Failed to stop recording.');
            }
        }).catch(function(error) {
            console.error('Error:', error);
        });
    });

    // $('#btn_download').click(function() {
    //     // 下载视频文件
    //     console.log('Downloading video...');
    //     fetch('/record_lasted.mp4', {
    //         method: 'GET'
    //     }).then(function(response) {
    //         if (response.ok) {
    //             return response.blob();
    //         } else {
    //             throw new Error('Failed to download the video.');
    //         }
    //     }).then(function(blob) {
    //         // 创建一个 Blob 对象
    //         const url = window.URL.createObjectURL(blob);
    //         // 创建一个隐藏的可下载链接
    //         const a = document.createElement('a');
    //         a.style.display = 'none';
    //         a.href = url;
    //         a.download = 'record_lasted.mp4';
    //         document.body.appendChild(a);
    //         // 触发下载
    //         a.click();
    //         // 清理
    //         window.URL.revokeObjectURL(url);
    //         document.body.removeChild(a);
    //         console.log('Video downloaded successfully.');
    //     }).catch(function(error) {
    //         console.error('Error:', error);
    //     });
    // });

	});

  
</script>
</html>
