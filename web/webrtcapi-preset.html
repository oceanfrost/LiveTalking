<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC - é¢„è®¾éŸ³é¢‘å¿«æ·å›å¤</title>
    <style>
    * {
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
        color: #333;
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 10px;
    }

    .controls {
        margin-bottom: 20px;
    }

    button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #start {
        background: #4CAF50;
        color: white;
    }

    #stop {
        background: #f44336;
        color: white;
    }

    .btn-record {
        background: #2196F3;
        color: white;
    }

    .btn-record:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .option {
        margin-bottom: 10px;
    }

    #media {
        max-width: 1280px;
        text-align: center;
    }

    video {
        width: 100%;
        max-width: 600px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .input-section {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .input-section h3 {
        margin-top: 0;
        color: #555;
    }

    textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
    }

    textarea:focus {
        outline: none;
        border-color: #4CAF50;
    }

    .preset-section {
        background: #fff3cd;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border: 2px solid #ffc107;
    }

    .preset-section h3 {
        margin-top: 0;
        color: #856404;
    }

    .preset-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .preset-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
        text-align: center;
    }

    .preset-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .preset-btn:active {
        transform: scale(0.98);
    }

    .preset-btn .label {
        display: block;
        font-weight: bold;
        margin-bottom: 3px;
    }

    .preset-btn .id {
        display: block;
        font-size: 11px;
        opacity: 0.8;
    }

    .status {
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 12px;
        margin: 15px 0;
        border-radius: 4px;
    }

    .info-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .info-box strong {
        display: block;
        margin-bottom: 5px;
    }

    .submit-btn {
        background: #28a745;
        color: white;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: bold;
    }

    .category {
        margin-bottom: 20px;
    }

    .category-title {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
        font-weight: 600;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ™ï¸ LiveTalking - WebRTC é¢„è®¾éŸ³é¢‘å¿«æ·å›å¤</h1>

    <div class="info-box">
        <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong>
        1. ç‚¹å‡»"Start"å¯åŠ¨è§†é¢‘è¿æ¥<br>
        2. ä½¿ç”¨é¢„è®¾æŒ‰é’®å¿«é€Ÿå›å¤ï¼ˆæ¨èï¼‰- ä½¿ç”¨é¢„å…ˆç”Ÿæˆçš„éŸ³é¢‘ï¼Œé›¶å»¶è¿Ÿ<br>
        3. æˆ–åœ¨æ–‡æœ¬æ¡†è¾“å…¥è‡ªå®šä¹‰å†…å®¹ - å®æ—¶TTSç”Ÿæˆ
    </div>

    <div class="controls">
        <div class="option">
            <input id="use-stun" type="checkbox"/>
            <label for="use-stun">Use STUN server</label>
        </div>
        <button id="start" onclick="start()">â–¶ï¸ Start</button>
        <button id="stop" style="display: none" onclick="stop()">â¹ï¸ Stop</button>
        <button class="btn-record" id="btn_start_record">ğŸ”´ Start Recording</button>
        <button class="btn-record" id="btn_stop_record" disabled>âºï¸ Stop Recording</button>
        <input type="hidden" id="sessionid" value="0">
    </div>

    <div id="media">
        <h2>ğŸ“º è§†é¢‘æ’­æ”¾</h2>
        <audio id="audio" autoplay="true"></audio>
        <video id="video" autoplay="true" playsinline="true"></video>
    </div>

    <!-- é¢„è®¾éŸ³é¢‘å¿«æ·æŒ‰é’® -->
    <div class="preset-section">
        <h3>âš¡ é¢„è®¾éŸ³é¢‘å¿«æ·å›å¤ï¼ˆé›¶å»¶è¿Ÿï¼‰</h3>
        <p style="color: #856404; font-size: 13px; margin-bottom: 10px;">
            ç‚¹å‡»æŒ‰é’®ç›´æ¥æ’­æ”¾é¢„è®¾éŸ³é¢‘ï¼Œç³»ç»Ÿä¼šå®æ—¶ç”Ÿæˆå¯¹åº”è§†é¢‘
        </p>

        <div class="category">
            <div class="category-title">ğŸ‘‹ æ¬¢è¿ä¸é—®å€™</div>
            <div class="preset-grid">
                <button class="preset-btn" onclick="sendPreset('welcome')">
                    <span class="label">æ¬¢è¿è¯­</span>
                    <span class="id">welcome</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('morning')">
                    <span class="label">æ—©å®‰</span>
                    <span class="id">morning</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('afternoon')">
                    <span class="label">ä¸‹åˆå¥½</span>
                    <span class="id">afternoon</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('evening')">
                    <span class="label">æ™šä¸Šå¥½</span>
                    <span class="id">evening</span>
                </button>
            </div>
        </div>

        <div class="category">
            <div class="category-title">â“ å¸¸è§é—®é¢˜</div>
            <div class="preset-grid">
                <button class="preset-btn" onclick="sendPreset('hours')">
                    <span class="label">è¥ä¸šæ—¶é—´</span>
                    <span class="id">hours</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('location')">
                    <span class="label">åœ°å€ä½ç½®</span>
                    <span class="id">location</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('contact')">
                    <span class="label">è”ç³»æ–¹å¼</span>
                    <span class="id">contact</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('price')">
                    <span class="label">ä»·æ ¼å¥—é¤</span>
                    <span class="id">price</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('features')">
                    <span class="label">åŠŸèƒ½ä»‹ç»</span>
                    <span class="id">features</span>
                </button>
            </div>
        </div>

        <div class="category">
            <div class="category-title">ğŸ’¬ å…¶ä»–</div>
            <div class="preset-grid">
                <button class="preset-btn" onclick="sendPreset('goodbye')">
                    <span class="label">å†è§</span>
                    <span class="id">goodbye</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('transfer')">
                    <span class="label">è½¬äººå·¥</span>
                    <span class="id">transfer</span>
                </button>
                <button class="preset-btn" onclick="sendPreset('retry')">
                    <span class="label">é‡å¤è¯´æ˜</span>
                    <span class="id">retry</span>
                </button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰æ–‡æœ¬è¾“å…¥ -->
    <div class="input-section">
        <h3>âœï¸ è‡ªå®šä¹‰æ–‡æœ¬è¾“å…¥ï¼ˆå®æ—¶TTSï¼‰</h3>
        <form id="echo-form">
            <textarea cols="2" rows="3" id="message" placeholder="è¾“å…¥ä»»æ„æ–‡æœ¬ï¼Œç³»ç»Ÿå°†ä½¿ç”¨å®æ—¶TTSç”Ÿæˆè¯­éŸ³...&#10;æˆ–è€…è¾“å…¥é¢„è®¾IDï¼ˆå¦‚: welcome, hoursç­‰ï¼‰ä½¿ç”¨é¢„è®¾éŸ³é¢‘">test</textarea>
            <div style="margin-top: 10px;">
                <button type="submit" class="submit-btn">ğŸ“¤ å‘é€</button>
            </div>
        </form>
    </div>

    <div class="status" id="status">
        ğŸ“Š çŠ¶æ€: å°±ç»ªï¼Œè¯·ç‚¹å‡» Start æŒ‰é’®å¼€å§‹
    </div>
</div>

<script src="client.js"></script>
<script type="text/javascript" src="http://cdn.sockjs.org/sockjs-0.3.4.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</body>
<script type="text/javascript" charset="utf-8">

    // é¢„è®¾éŸ³é¢‘IDåˆ—è¡¨ï¼ˆç”¨äºè¯†åˆ«ï¼‰
    const PRESET_IDS = [
        'welcome', 'morning', 'afternoon', 'evening',
        'hours', 'location', 'contact', 'price', 'features',
        'goodbye', 'transfer', 'retry'
    ];

    // å‘é€é¢„è®¾éŸ³é¢‘è¯·æ±‚
    function sendPreset(presetId) {
        console.log('å‘é€é¢„è®¾éŸ³é¢‘: ' + presetId);
        updateStatus('ğŸµ æ­£åœ¨æ’­æ”¾é¢„è®¾: ' + presetId);
        
        fetch('/human', {
            body: JSON.stringify({
                text: presetId,
                type: 'echo',
                interrupt: true,
                sessionid: parseInt(document.getElementById('sessionid').value),
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            method: 'POST'
        }).then(response => response.json())
          .then(data => {
              if (data.code === 0) {
                  updateStatus('âœ… é¢„è®¾éŸ³é¢‘æ’­æ”¾æˆåŠŸ: ' + presetId);
              } else {
                  updateStatus('âŒ æ’­æ”¾å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
              }
          })
          .catch(error => {
              console.error('Error:', error);
              updateStatus('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
          });
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(message) {
        const statusEl = document.getElementById('status');
        const timestamp = new Date().toLocaleTimeString();
        statusEl.textContent = `[${timestamp}] ${message}`;
    }

    $(document).ready(function() {
        // è¡¨å•æäº¤å¤„ç†
        $('#echo-form').on('submit', function(e) {
            e.preventDefault();
            var message = $('#message').val().trim();
            
            if (!message) {
                updateStatus('âš ï¸ è¯·è¾“å…¥æ–‡æœ¬å†…å®¹');
                return;
            }

            console.log('å‘é€æ–‡æœ¬: ' + message);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„è®¾ID
            if (PRESET_IDS.includes(message)) {
                updateStatus('ğŸµ æ£€æµ‹åˆ°é¢„è®¾IDï¼Œä½¿ç”¨é¢„è®¾éŸ³é¢‘: ' + message);
            } else {
                updateStatus('ğŸ¤ ä½¿ç”¨å®æ—¶TTSç”Ÿæˆ: ' + message);
            }
            
            fetch('/human', {
                body: JSON.stringify({
                    text: message,
                    type: 'echo',
                    interrupt: true,
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(response => response.json())
              .then(data => {
                  if (data.code === 0) {
                      updateStatus('âœ… å‘é€æˆåŠŸ');
                  } else {
                      updateStatus('âŒ å‘é€å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  updateStatus('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
              });
            
            $('#message').val('');
        });

        // å½•åˆ¶å¼€å§‹
        $('#btn_start_record').click(function() {
            console.log('å¼€å§‹å½•åˆ¶...');
            updateStatus('ğŸ”´ å¼€å§‹å½•åˆ¶...');
            
            fetch('/record', {
                body: JSON.stringify({
                    type: 'start_record',
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(function(response) {
                if (response.ok) {
                    console.log('å½•åˆ¶å·²å¼€å§‹');
                    updateStatus('âœ… å½•åˆ¶å·²å¼€å§‹');
                    $('#btn_start_record').prop('disabled', true);
                    $('#btn_stop_record').prop('disabled', false);
                } else {
                    console.error('å½•åˆ¶å¯åŠ¨å¤±è´¥');
                    updateStatus('âŒ å½•åˆ¶å¯åŠ¨å¤±è´¥');
                }
            }).catch(function(error) {
                console.error('Error:', error);
                updateStatus('âŒ é”™è¯¯: ' + error.message);
            });
        });

        // å½•åˆ¶ç»“æŸ
        $('#btn_stop_record').click(function() {
            console.log('åœæ­¢å½•åˆ¶...');
            updateStatus('âºï¸ åœæ­¢å½•åˆ¶...');
            
            fetch('/record', {
                body: JSON.stringify({
                    type: 'end_record',
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(function(response) {
                if (response.ok) {
                    console.log('å½•åˆ¶å·²åœæ­¢');
                    updateStatus('âœ… å½•åˆ¶å·²åœæ­¢ï¼Œæ–‡ä»¶å·²ä¿å­˜');
                    $('#btn_start_record').prop('disabled', false);
                    $('#btn_stop_record').prop('disabled', true);
                } else {
                    console.error('å½•åˆ¶åœæ­¢å¤±è´¥');
                    updateStatus('âŒ å½•åˆ¶åœæ­¢å¤±è´¥');
                }
            }).catch(function(error) {
                console.error('Error:', error);
                updateStatus('âŒ é”™è¯¯: ' + error.message);
            });
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        updateStatus('âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡» Start æŒ‰é’®å¼€å§‹');
    });
  
</script>
</html>
